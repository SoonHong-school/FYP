<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Car Service Appointment | AutoCarMatch</title>
  <!-- Page-specific styles -->
  <link rel="stylesheet" href="assets/css/CarService.css">
  <link rel="stylesheet" href="assets/css/Footer.css">
</head>

<body>
  <!-- Navbar -->
  <div id="navbar"></div>

  <!-- Car Service Appointment Section -->
  <section class="service-section">
    <div class="service-card">
      <h2>Book Car Service</h2>
      <form id="carServiceForm">

        <!-- Car Selection -->
        <label for="userCar">Select Your Car</label>
        <select id="userCar" required>
          <option value="">-- Select Your Car --</option>
        </select>

        <!-- Phone Number -->
        <label for="phoneNumber">Phone Number</label>
        <input type="tel" id="phoneNumber" placeholder="0123456789" pattern="[0-9]{10,11}" required>

        <!-- Service Type -->
        <label for="serviceType">Service Type</label>
        <select id="serviceType" required>
          <option value="">-- Select Service Type --</option>
        </select>

        <!-- Preferred Date -->
        <label for="serviceDate">Preferred Date</label>
        <input type="date" id="serviceDate" required>

        <!-- Preferred Time -->
        <label for="serviceTime">Preferred Time</label>
        <select id="serviceTime" required>
          <option value="">-- Select Time Slot --</option>
        </select>

        <button type="submit">Check Available Agents</button>
        <p id="serviceMessage" class="msg"></p>
      </form>
    </div>
  </section>

  <!-- Available Agents Section -->
  <section class="agents-section" id="agentsSection" style="display: none;">
    <div class="agents-card">
      <h2>Available Agents</h2>
      <div id="agentsList" class="agents-list"></div>
    </div>
  </section>

  <!-- Footer -->
  <div id="footer"></div>

  <!-- Confirmation Popup -->
  <div id="confirmationPopup" class="popup-overlay" style="display: none;">
    <div class="popup-box">
      <h2>Appointment Confirmed!</h2>
      <p>Your service appointment has been successfully booked.</p>
      <button id="confirmOkBtn">Okay</button>
    </div>
  </div>


  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import {
      getFirestore,
      collection,
      query,
      where,
      getDocs,
      addDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // ====== FIREBASE CONFIG ======
    const firebaseConfig = {
      apiKey: "AIzaSyD882u-zk7FB3YMwL0Nm3_VYD4xsCMt6cQ",
      authDomain: "carlisting-f88f2.firebaseapp.com",
      projectId: "carlisting-f88f2",
      storageBucket: "carlisting-f88f2.appspot.com",
      messagingSenderId: "49221518207",
      appId: "1:49221518207:web:c5e2fd962b802322bfd04a",
      measurementId: "G-EMFC5Q8FZ5"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const userCarSelect = document.getElementById("userCar");
    const serviceTypeSelect = document.getElementById("serviceType");
    const serviceDateInput = document.getElementById("serviceDate");
    const serviceTimeSelect = document.getElementById("serviceTime");

    // ====== PROTECT PAGE: REQUIRE LOGIN ======
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "Login.html";
        return;
      }

      const carsRef = collection(db, "users", user.uid, "cars");
      const querySnapshot = await getDocs(carsRef);

      // Get all cars that already have an active appointment
      const activeAppointmentsQuery = query(
        collection(db, "carServiceAppointments"),
        where("userId", "==", user.uid),
        where("status", "in", ["pending", "accepted"])
      );
      const activeAppointmentsSnap = await getDocs(activeAppointmentsQuery);

      // Store car IDs that are currently booked
      const carsWithAppointments = new Set();
      activeAppointmentsSnap.forEach(docSnap => {
        const data = docSnap.data();
        if (data.carId) carsWithAppointments.add(data.carId);
      });

      if (querySnapshot.empty) {
        const option = document.createElement("option");
        option.value = "";
        option.textContent = "‚ö†Ô∏è No cars found. Please add one in your profile.";
        userCarSelect.appendChild(option);
        userCarSelect.disabled = true;
      } else {
        querySnapshot.forEach(docSnap => {
          const car = docSnap.data();
          const option = document.createElement("option");
          option.value = JSON.stringify({
            id: docSnap.id,
            type: car.type,
            brand: car.brand,
            model: car.model,
            number: car.plate
          });

          // Check if this car is already in an active appointment
          if (carsWithAppointments.has(docSnap.id)) {
            option.disabled = true;
            option.textContent = `${car.brand} ${car.model} (${car.plate}) ‚Äî üü° In Service`;
          } else {
            option.textContent = `${car.brand} ${car.model} (${car.plate})`;
          }

          userCarSelect.appendChild(option);
        });
      }
    });


    // ====== SERVICE OPTIONS BASED ON CAR TYPE ======
    const petrolServices = [
      { value: "maintenance", label: "General Maintenance" },
      { value: "oilChange", label: "Oil Change" },
      { value: "inspection", label: "Car Inspection" },
      { value: "repair", label: "Repair" }
    ];

    const evServices = [
      { value: "batteryCheck", label: "Battery Check" },
      { value: "softwareUpdate", label: "Software Update" },
      { value: "evInspection", label: "EV Inspection" },
      { value: "chargerRepair", label: "Charger Repair" }
    ];

    // ====== SERVICE OPTIONS & AUTO-SUGGESTION BASED ON MILEAGE ======
    userCarSelect.addEventListener("change", async () => {
      serviceTypeSelect.innerHTML = '<option value="">-- Select Service Type --</option>';
      document.querySelectorAll(".auto-msg").forEach(el => el.remove()); // remove old messages

      if (!userCarSelect.value) return;

      const carData = JSON.parse(userCarSelect.value);
      const carsRef = collection(db, "users", auth.currentUser.uid, "cars");
      const carDocs = await getDocs(carsRef);
      let selectedCarMileage = 0;

      carDocs.forEach(docSnap => {
        const car = docSnap.data();
        if (docSnap.id === carData.id) {
          selectedCarMileage = parseFloat(car.mileage) || 0;
        }
      });

      let recommendedService = null;
      let services = [];

      if (carData.type.toLowerCase() === "ev") {
        // EV-specific recommendations
        services = [
          { value: "evBasic", label: "Basic EV Check (Under 10,000 km)" },
          { value: "batteryCheck", label: "Battery & Software Update (10,000‚Äì20,000 km)" },
          { value: "evInspection", label: "Full EV Inspection (20,000‚Äì40,000 km)" },
          { value: "electricalCheck", label: "Full Electrical System Check (40,000+ km)" }
        ];

        if (selectedCarMileage < 10000) recommendedService = services[0];
        else if (selectedCarMileage < 20000) recommendedService = services[1];
        else if (selectedCarMileage < 40000) recommendedService = services[2];
        else recommendedService = services[3];
      } else {
        // Petrol/Diesel recommendations
        services = [
          { value: "maintenance", label: "General Maintenance (Under 5,000 km)" },
          { value: "oilChange", label: "Oil Change (5,000‚Äì10,000 km)" },
          { value: "inspection", label: "Full Inspection (10,000‚Äì20,000 km)" },
          { value: "repair", label: "Full Service (20,000+ km)" }
        ];

        if (selectedCarMileage < 5000) recommendedService = services[0];
        else if (selectedCarMileage < 10000) recommendedService = services[1];
        else if (selectedCarMileage < 20000) recommendedService = services[2];
        else recommendedService = services[3];
      }

      // Populate dropdown
      services.forEach(service => {
        const option = document.createElement("option");
        option.value = service.value;
        option.textContent = service.label;
        serviceTypeSelect.appendChild(option);
      });

      // Auto-select recommendation
      if (recommendedService) {
        serviceTypeSelect.value = recommendedService.value;

        const msg = document.createElement("p");
        msg.textContent = `‚úÖ Based on your mileage (${selectedCarMileage.toLocaleString()} km), we recommend: ${recommendedService.label}`;
        msg.style.color = "green";
        msg.style.marginTop = "8px";
        msg.classList.add("auto-msg");
        serviceTypeSelect.insertAdjacentElement("afterend", msg);
      }
    });



    // ====== DATE RESTRICTIONS ======
    const today = new Date();
    today.setDate(today.getDate() + 1); // start from tomorrow
    const minDate = today.toISOString().split("T")[0];
    serviceDateInput.min = minDate;

    // ====== TIME SLOTS ======
    function generateTimeSlots() {
      serviceTimeSelect.innerHTML = '<option value="">-- Select Time Slot --</option>';
      for (let hour = 10; hour <= 18; hour++) {
        const timeStr = hour.toString().padStart(2, "0") + ":00";
        const option = document.createElement("option");
        option.value = timeStr;
        option.textContent = timeStr;
        serviceTimeSelect.appendChild(option);
      }
    }
    generateTimeSlots();

    // ====== FORM SUBMIT ======
    document.getElementById("carServiceForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const user = auth.currentUser;
      if (!user) return alert("‚ö†Ô∏è You must be logged in to book.");

      if (!userCarSelect.value) {
        alert("‚ùå Please select your car.");
        return;
      }

      const carData = JSON.parse(userCarSelect.value);
      const phoneNumber = document.getElementById("phoneNumber").value;
      const serviceType = serviceTypeSelect.value;
      const serviceDate = serviceDateInput.value;
      const serviceTime = serviceTimeSelect.value;
      const serviceMessage = document.getElementById("serviceMessage");
      const agentsSection = document.getElementById("agentsSection");
      const agentsList = document.getElementById("agentsList");

      serviceMessage.textContent = "‚úÖ Checking available agents...";
      serviceMessage.style.color = "green";

      try {
        // 1. Get all agents of this car type
        const q = query(
          collection(db, "users"),
          where("role", "==", "agent"),
          where("type", "==", carData.type)
        );
        const querySnapshot = await getDocs(q);

        if (querySnapshot.empty) {
          serviceMessage.textContent = "‚ùå No agents for this car type.";
          serviceMessage.style.color = "red";
          agentsSection.style.display = "none";
          return;
        }

        // 2. Check already booked agents
        const bookedQuery = query(
          collection(db, "carServiceAppointments"),
          where("serviceDate", "==", serviceDate),
          where("serviceTime", "==", serviceTime)
        );
        const bookedSnapshot = await getDocs(bookedQuery);

        const bookedAgents = new Set();
        bookedSnapshot.forEach(doc => {
          bookedAgents.add(doc.data().agentId);
        });

        // 3. Show available agents
        agentsList.innerHTML = "";
        let availableCount = 0;

        querySnapshot.forEach(doc => {
          const agent = doc.data();
          if (!bookedAgents.has(doc.id)) {
            availableCount++;
            const div = document.createElement("div");
            div.className = "agent-card";
            div.innerHTML = `
              <h3>${agent.name || "Unnamed Agent"}</h3>
              <p><strong>Specialty:</strong> ${agent.specialty || "General Service"}</p>
              <p><strong>Type:</strong> ${agent.type.toUpperCase()}</p>
              <button class="book-btn">Book with ${agent.name || "Agent"}</button>
            `;

            div.querySelector(".book-btn").addEventListener("click", async () => {
              try {
                await addDoc(collection(db, "carServiceAppointments"), {
                  userId: user.uid,
                  userEmail: user.email,
                  phoneNumber,
                  carId: carData.id,
                  carType: carData.type,
                  carModel: carData.model,
                  carNumber: carData.number,
                  serviceType,
                  serviceDate,
                  serviceTime,
                  agentId: doc.id,
                  agentName: agent.name,
                  createdAt: serverTimestamp(),
                  status: "pending"
                });
                // Show custom confirmation popup
                const popup = document.getElementById("confirmationPopup");
                popup.style.display = "flex";

                document.getElementById("confirmOkBtn").onclick = () => {
                  popup.style.display = "none";
                  window.location.href = "UserProfile.html"; 
                };

              } catch (err) {
                console.error(err);
                alert("‚ùå Failed to save appointment: " + err.message);
              }
            });

            agentsList.appendChild(div);
          }
        });

        if (availableCount === 0) {
          serviceMessage.textContent = "‚ùå No agents available at this time.";
          serviceMessage.style.color = "red";
          agentsSection.style.display = "none";
        } else {
          agentsSection.style.display = "block";
          serviceMessage.textContent = "";
        }

      } catch (err) {
        console.error(err);
        serviceMessage.textContent = "‚ùå Failed to load agents.";
        serviceMessage.style.color = "red";
      }
    });
  </script>

  <script type="module">
    import { loadNavbar } from "./assets/js/Navbar.js";
    loadNavbar();
  </script>
  <script type="module">
    import { loadFooter } from "./assets/js/Footer.js";
    loadFooter();
  </script>
</body>

</html>