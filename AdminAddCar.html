<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - Insert Car Wizard</title>
  <link rel="stylesheet" href="assets/css/AdminAddCar.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
  <div class="admin-container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="logo">
        <a href="AdminHome.html">
          <img src="assets/images/logo.png" alt="AutoCarMatch Logo" style="height:50px;">
        </a>
      </div>
      <ul class="menu">
        <li><a href="AdminHome.html"><i class="fas fa-home"></i> Dashboard</a></li>
        <li><a href="AdminAddCar.html" class="active"><i class="fas fa-plus-circle"></i> Insert Car</a></li>
        <li><a href="AdminManageCars.html"><i class="fas fa-cogs"></i> Manage Cars</a></li>
        <li><a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
      </ul>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <section class="insert-car">
        <h2>Insert New Car</h2>

        <!-- Progress Bar -->
        <ul class="progressbar">
          <li class="active">Type</li>
          <li>Brand</li>
          <li>Model</li>
          <li>Details</li>
        </ul>

        <form id="insertCarForm">
          <!-- Step 1: Car Type -->
          <div class="step active" data-step="1">
            <label for="carType">Select Car Type</label>
            <select id="carType" name="carType" required>
              <option value="">-- Select Type --</option>
              <option value="Petrol">Petrol</option>
              <option value="EV">EV</option>
              <option value="Hybrid">Hybrid</option>
            </select>
            <div class="wizard-buttons">
              <button type="button" onclick="nextStep()">Next</button>
            </div>
          </div>

          <!-- Step 2: Brand -->
          <div class="step" data-step="2">
            <label>Choose Brand</label>
            <select id="brandChoice">
              <option value="">-- Select --</option>
              <option value="existing">Existing Brand</option>
              <option value="new">New Brand</option>
            </select>
            <div id="existingBrandBox" style="display:none;">
              <label for="existingBrand">Select Existing Brand</label>
              <select id="existingBrand"></select>
            </div>
            <div id="newBrandBox" style="display:none;">
              <label for="newBrand">New Brand Name</label>
              <input type="text" id="newBrand" placeholder="e.g. Tesla" />
            </div>
            <div class="wizard-buttons">
              <button type="button" onclick="prevStep()">Back</button>
              <button type="button" onclick="nextStep()">Next</button>
            </div>
          </div>

          <!-- Step 3: Model -->
          <div class="step" data-step="3">
            <div id="newModelBox">
              <label for="newModel">Model Name</label>
              <input type="text" id="newModel" placeholder="e.g. Corolla Altis" />
            </div>
            <div class="wizard-buttons">
              <button type="button" onclick="prevStep()">Back</button>
              <button type="button" onclick="nextStep()">Next</button>
            </div>
          </div>

          <!-- Step 4: Details -->
          <div class="step" data-step="4">
            <label for="carYear">Manufacture Year</label>
            <input type="number" id="carYear" min="1980" max="2099" required>

            <label for="carPrice">Price (RM)</label>
            <input type="number" id="carPrice" min="1000" required>

            <label for="carTransmission">Transmission</label>
            <select id="carTransmission" required>
              <option value="">-- Select Transmission --</option>
              <option value="Automatic">Automatic</option>
              <option value="Manual">Manual</option>
            </select>

            <label for="carSeats">Seats</label>
            <select id="carSeats" required>
              <option value="">-- Select Seats --</option>
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
              <option value="5">5</option>
              <option value="6">6</option>
            </select>

            <label for="carMileage">Mileage (km)</label>
            <input type="number" id="carMileage" min="0" required>

            <label for="carColor">Color</label>
            <input type="text" id="carColor" placeholder="e.g. Red, Black, White" required>

            <label for="carDescription">Description</label>
            <input type="text" id="carDescription" placeholder="Input the text here" required>

            <label for="carEngine">‚öô Engine</label>
            <input type="text" id="carEngine" placeholder="e.g. 2.0L Turbo" required>

            <label for="carDimensions">üìè Dimensions</label>
            <input type="text" id="carDimensions" placeholder="e.g. 4,500mm x 1,800mm x 1,600mm" required>

            <label for="carSafety">üõ° Safety</label>
            <input type="text" id="carSafety" placeholder="e.g. ABS, Airbags, Lane Assist" required>


            <label for="pricePdf">Upload Price PDF</label>
            <input type="file" id="pricePdf" accept="application/pdf">

            <label for="brochurePdf">Upload Brochure PDF</label>
            <input type="file" id="brochurePdf" accept="application/pdf">


            <!-- Exterior Upload Section -->
            <label for="carImages">Upload Car Images (max 30)</label>
            <input type="file" id="carImages" accept="image/*" multiple required>
            <div id="imagePreview" style="display:flex;flex-wrap:wrap;gap:8px;margin-top:10px;"></div>

            <!-- Interior Upload Section -->
            <label for="interiorImages">Upload Interior Photos (max 20)</label>
            <input type="file" id="interiorImages" accept="image/*" multiple>
            <div id="interiorPreview" style="display:flex;flex-wrap:wrap;gap:8px;margin-top:10px;"></div>

            <div class="wizard-buttons">
              <button type="button" onclick="prevStep()">Back</button>
              <button type="submit">Add Car</button>
            </div>
          </div>
        </form>

        <p id="insertMessage"></p>
      </section>

      <!-- Firebase + Cloudinary Logic -->
      <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, query, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyD882u-zk7FB3YMwL0Nm3_VYD4xsCMt6cQ",
          authDomain: "carlisting-f88f2.firebaseapp.com",
          projectId: "carlisting-f88f2",
          storageBucket: "carlisting-f88f2.appspot.com",
          messagingSenderId: "49221518207",
          appId: "1:49221518207:web:c5e2fd962b802322bfd04a",
          measurementId: "G-EMFC5Q8FZ5"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // authorized for admin only

        onAuthStateChanged(auth, async (user) => {
          if (!user) {
            window.location.href = "Login.html";
            return;
          }

          const ref = doc(db, "users", user.uid);
          const snap = await getDoc(ref);

          if (!snap.exists() || snap.data().role !== "admin") {
            alert("Access denied. Admins only.");
            window.location.href = "Login.html";
            return;
          }

          document.body.style.opacity = "1"; 
        });

        const CLOUD_NAME = "dwxsc3aec";
        const UPLOAD_PRESET = "unsigned_preset";

        let currentStep = 1;
        function showStep(step) {
          document.querySelectorAll(".step").forEach(div => div.classList.remove("active"));
          document.querySelector(`.step[data-step="${step}"]`).classList.add("active");
          updateProgress(step);
          currentStep = step;
        }
        window.nextStep = () => showStep(currentStep + 1);
        window.prevStep = () => showStep(currentStep - 1);

        function updateProgress(step) {
          const items = document.querySelectorAll(".progressbar li");
          items.forEach((li, i) => {
            li.classList.remove("active", "completed");
            if (i < step - 1) li.classList.add("completed");
            if (i === step - 1) li.classList.add("active");
          });
        }

        // Toggle existing/new brand
        document.getElementById("brandChoice").addEventListener("change", async (e) => {
          if (e.target.value === "existing") {
            document.getElementById("existingBrandBox").style.display = "block";
            document.getElementById("newBrandBox").style.display = "none";
            const snap = await getDocs(collection(db, "brands"));
            let sel = document.getElementById("existingBrand");
            sel.innerHTML = snap.docs.map(d => `<option value="${d.data().name}">${d.data().name}</option>`).join("");
          } else if (e.target.value === "new") {
            document.getElementById("newBrandBox").style.display = "block";
            document.getElementById("existingBrandBox").style.display = "none";
          } else {
            document.getElementById("newBrandBox").style.display = "none";
            document.getElementById("existingBrandBox").style.display = "none";
          }
        });

        // Preview uploaded images
        document.getElementById("carImages").addEventListener("change", (e) => {
          const files = Array.from(e.target.files).slice(0, 30);
          const preview = document.getElementById("imagePreview");
          preview.innerHTML = "";
          files.forEach((file, index) => {
            const reader = new FileReader();
            reader.onload = (ev) => {
              const div = document.createElement("div");
              div.style.display = "flex";
              div.style.flexDirection = "column";
              div.style.alignItems = "center";
              div.style.gap = "4px";
              const img = document.createElement("img");
              img.src = ev.target.result;
              img.style.width = "80px";
              img.style.height = "60px";
              img.style.objectFit = "cover";
              img.style.borderRadius = "6px";
              div.appendChild(img);
              const orderInput = document.createElement("input");
              orderInput.type = "number";
              orderInput.min = 1;
              orderInput.max = files.length;
              orderInput.value = index + 1;
              orderInput.style.width = "50px";
              orderInput.dataset.index = index;
              div.appendChild(orderInput);
              preview.appendChild(div);
            };
            reader.readAsDataURL(file);
          });
        });

        // Preview uploaded interior images
        document.getElementById("interiorImages").addEventListener("change", (e) => {
          const files = Array.from(e.target.files).slice(0, 20);
          const preview = document.getElementById("interiorPreview");
          preview.innerHTML = "";
          files.forEach((file, index) => {
            const reader = new FileReader();
            reader.onload = (ev) => {
              const div = document.createElement("div");
              div.style.display = "flex";
              div.style.flexDirection = "column";
              div.style.alignItems = "center";
              div.style.gap = "4px";
              const img = document.createElement("img");
              img.src = ev.target.result;
              img.style.width = "80px";
              img.style.height = "60px";
              img.style.objectFit = "cover";
              img.style.borderRadius = "6px";
              div.appendChild(img);
              const orderInput = document.createElement("input");
              orderInput.type = "number";
              orderInput.min = 1;
              orderInput.max = files.length;
              orderInput.value = index + 1;
              orderInput.style.width = "50px";
              orderInput.dataset.index = index;
              div.appendChild(orderInput);
              preview.appendChild(div);
            };
            reader.readAsDataURL(file);
          });
        });

        // Submit form
        document.getElementById("insertCarForm").addEventListener("submit", async (e) => {
          e.preventDefault();
          const msg = document.getElementById("insertMessage");

          let type = document.getElementById("carType").value;
          let brand = document.getElementById("brandChoice").value === "existing" ? document.getElementById("existingBrand").value : document.getElementById("newBrand").value;
          let model = document.getElementById("newModel").value;
          let year = parseInt(document.getElementById("carYear").value);
          let price = parseFloat(document.getElementById("carPrice").value);
          let transmission = document.getElementById("carTransmission").value;
          let seats = parseInt(document.getElementById("carSeats").value);
          let mileage = parseInt(document.getElementById("carMileage").value);
          let color = document.getElementById("carColor").value.trim();
          let description = document.getElementById("carDescription").value.trim();

          // Upload PDFs
          let pricePdfUrl = "";
          let brochurePdfUrl = "";
          const pricePdfFile = document.getElementById("pricePdf").files[0];
          const brochurePdfFile = document.getElementById("brochurePdf").files[0];

          if (pricePdfFile) {
            const formData = new FormData();
            formData.append("file", pricePdfFile);
            formData.append("upload_preset", UPLOAD_PRESET);
            const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/auto/upload`, { method: "POST", body: formData });
            const data = await res.json();
            pricePdfUrl = data.secure_url;
          }

          if (brochurePdfFile) {
            const formData = new FormData();
            formData.append("file", brochurePdfFile);
            formData.append("upload_preset", UPLOAD_PRESET);
            const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/auto/upload`, { method: "POST", body: formData });
            const data = await res.json();
            brochurePdfUrl = data.secure_url;
          }

          // Exterior images
          let files = Array.from(document.getElementById("carImages").files).slice(0, 30);
          if (files.length === 0) {
            msg.textContent = "‚ùå Please upload at least one image";
            msg.style.color = "red";
            return;
          }

          const orderInputs = Array.from(document.querySelectorAll("#imagePreview input[type='number']"));
          files.sort((a, b) => {
            const indexA = orderInputs.find(input => input.dataset.index == files.indexOf(a)).value;
            const indexB = orderInputs.find(input => input.dataset.index == files.indexOf(b)).value;
            return parseInt(indexA) - parseInt(indexB);
          });

          msg.textContent = "‚è≥ Uploading exterior images...";
          msg.style.color = "blue";

          let uploadedUrls = [];
          for (let file of files) {
            const formData = new FormData();
            formData.append("file", file);
            formData.append("upload_preset", UPLOAD_PRESET);
            const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, { method: "POST", body: formData });
            const data = await res.json();
            uploadedUrls.push(data.secure_url);
          }

          // Interior images
          const interiorFiles = Array.from(document.getElementById("interiorImages").files).slice(0, 20);
          let interiorUploadedUrls = [];

          if (interiorFiles.length > 0) {
            msg.textContent = "‚è≥ Uploading interior photos...";
            const orderInputs2 = Array.from(document.querySelectorAll("#interiorPreview input[type='number']"));
            interiorFiles.sort((a, b) => {
              const indexA = orderInputs2.find(input => input.dataset.index == interiorFiles.indexOf(a)).value;
              const indexB = orderInputs2.find(input => input.dataset.index == interiorFiles.indexOf(b)).value;
              return parseInt(indexA) - parseInt(indexB);
            });

            for (let file of interiorFiles) {
              const formData = new FormData();
              formData.append("file", file);
              formData.append("upload_preset", UPLOAD_PRESET);
              const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, { method: "POST", body: formData });
              const data = await res.json();
              interiorUploadedUrls.push(data.secure_url);
            }
          }

          try {
            // Save brand if not exists
            const brandQuery = query(collection(db, "brands"), where("name", "==", brand));
            const brandSnap = await getDocs(brandQuery);
            if (brandSnap.empty) {
              await addDoc(collection(db, "brands"), { name: brand, createdAt: serverTimestamp() });
            }

            // Save model
            await addDoc(collection(db, "models"), { name: model, brand: brand, createdAt: serverTimestamp() });

            // Save car details
            await addDoc(collection(db, "cars"), {
              type, brand, model, year, price,
              transmission, seats, mileage, color, description,
              engine: document.getElementById("carEngine").value.trim(),
              dimensions: document.getElementById("carDimensions").value.trim(),
              safety: document.getElementById("carSafety").value.trim(),
              images: uploadedUrls,
              interiorImages: interiorUploadedUrls,
              pricePdf: pricePdfUrl,
              brochurePdf: brochurePdfUrl,
              createdAt: serverTimestamp()
            });


            msg.textContent = "‚úÖ Car, brand, model, and images added successfully!";
            msg.style.color = "green";
            document.getElementById("insertCarForm").reset();
            document.getElementById("imagePreview").innerHTML = "";
            document.getElementById("interiorPreview").innerHTML = "";
            showStep(1);
          } catch (err) {
            msg.textContent = "‚ùå " + err.message;
            msg.style.color = "red";
          }
        });

        // ====== LOGOUT HANDLER ======
        const logoutBtn = document.getElementById("logoutBtn");
        if (logoutBtn) {
          logoutBtn.addEventListener("click", async (e) => {
            e.preventDefault();
            try {
              await signOut(auth);

              // Clear local/session storage
              localStorage.clear();
              sessionStorage.clear();

              // Redirect to login
              window.location.href = "Login.html";
            } catch (err) {
              console.error("Logout failed:", err);
            }
          });
        }

      </script>
    </main>
  </div>
</body>

</html>