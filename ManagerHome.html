<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Manager | AutoCarMatch</title>
  <link rel="stylesheet" href="assets/css/ManagerHome.css">
  <link rel="stylesheet" href="assets/css/Footer.css">
  <link rel="stylesheet" href="assets/css/Navbar.css">
</head>
<body>
  <!-- Navbar -->
  <div id="navbar"></div>

  <header>
    <h1>Manager Dashboard</h1>
  </header>

  <main class="dashboard-container">
    <!-- Summary Cards -->
    <section class="summary-cards">
      <div class="card">
        <h3>Pending Agents</h3>
        <p id="pendingCount">0</p>
      </div>
      <div class="card">
        <h3>Approved Agents</h3>
        <p id="approvedCount">0</p>
      </div>
    </section>

    <!-- Search Bar -->
    <div class="search-bar">
      <input type="text" id="searchInput" placeholder="🔍 Search agents by name or email...">
    </div>

    <div class="dashboard">
      <!-- Pending Agents -->
      <section class="pending-section">
        <h2>Pending Agents</h2>
        <ul id="pendingList" class="agent-list"></ul>
      </section>

      <!-- Approved Agents -->
      <section class="approved-section">
        <h2>Approved Agents</h2>
        <ul id="approvedList" class="agent-list"></ul>
      </section>
    </div>
  </main>

  <!-- Footer -->
  <div id="footer"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { 
      getFirestore, collection, query, where, updateDoc, doc, onSnapshot 
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { loadNavbar } from "./assets/js/Navbar.js";
    import { loadFooter } from "./assets/js/Footer.js";

    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyD882u-zk7FB3YMwL0Nm3_VYD4xsCMt6cQ",
      authDomain: "carlisting-f88f2.firebaseapp.com",
      projectId: "carlisting-f88f2",
      storageBucket: "carlisting-f88f2.appspot.com",
      messagingSenderId: "49221518207",
      appId: "1:49221518207:web:c5e2fd962b802322bfd04a",
      measurementId: "G-EMFC5Q8FZ5"
    };

    // Init Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const pendingList = document.getElementById("pendingList");
    const approvedList = document.getElementById("approvedList");
    const pendingCount = document.getElementById("pendingCount");
    const approvedCount = document.getElementById("approvedCount");
    const searchInput = document.getElementById("searchInput");

    let pendingAgents = [];
    let approvedAgents = [];

    // Render Pending Agents
    function renderPendingAgent(docSnap) {
      return `
        <li>
          <span>${docSnap.data().name} (${docSnap.data().email})</span>
          <button class="approve-btn" data-id="${docSnap.id}">Approve</button>
        </li>
      `;
    }

    // Render Approved Agents
    function renderApprovedAgent(docSnap) {
      return `<li>${docSnap.data().name} (${docSnap.data().email})</li>`;
    }

    // Filter & Display
    function displayAgents() {
      const search = searchInput.value.toLowerCase();

      // Pending
      pendingList.innerHTML = "";
      pendingAgents
        .filter(a => a.data().name.toLowerCase().includes(search) || a.data().email.toLowerCase().includes(search))
        .forEach(docSnap => {
          pendingList.innerHTML += renderPendingAgent(docSnap);
        });

      // Approved
      approvedList.innerHTML = "";
      approvedAgents
        .filter(a => a.data().name.toLowerCase().includes(search) || a.data().email.toLowerCase().includes(search))
        .forEach(docSnap => {
          approvedList.innerHTML += renderApprovedAgent(docSnap);
        });

      // Add event listeners for approve buttons
      document.querySelectorAll(".approve-btn").forEach(btn => {
        btn.addEventListener("click", async () => {
          const id = btn.getAttribute("data-id");
          await updateDoc(doc(db, "users", id), {
            role: "agent",
            approved: true,
            approvedAt: new Date()
          });
        });
      });
    }

    // Live listener for pending agents
    onSnapshot(query(collection(db, "users"), where("role", "==", "pending-agent")), (snapshot) => {
      pendingAgents = snapshot.docs;
      pendingCount.textContent = pendingAgents.length;
      displayAgents();
    });

    // Live listener for approved agents
    onSnapshot(query(collection(db, "users"), where("role", "==", "agent")), (snapshot) => {
      approvedAgents = snapshot.docs;
      approvedCount.textContent = approvedAgents.length;
      displayAgents();
    });

    // Search input handler
    searchInput.addEventListener("input", displayAgents);

    // Load Navbar & Footer
    loadNavbar();
    loadFooter();
  </script>
</body>
</html>
