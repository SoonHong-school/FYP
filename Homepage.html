<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Car Listing Website</title>
  <link rel="stylesheet" href="assets/css/Homepage.css">
  <link rel="stylesheet" href="assets/css/Footer.css">
</head>

<body>

  <div id="navbar"></div>

  <!-- Hero Section -->
  <section class="hero-container">

    <!-- Filter Box -->
    <div class="filter-box">
      <h3>Find new & used cars for sale</h3>
      <select id="filterCondition">
        <option value="">All Condition</option>
      </select>

      <select id="filterBrand">
        <option value="">All Brands</option>
      </select>

      <select id="filterModel">
        <option value="">All Models</option>
      </select>

      <select id="filterState">
        <option value="">All States</option>
      </select>

      <select id="filterPrice">
        <option value="">All Prices</option>
        <option value="below50">Below RM50k</option>
        <option value="50to100">RM50k - RM100k</option>
        <option value="above100">Above RM100k</option>
      </select>

      <input type="text" id="filterSearch" placeholder="What car are you looking for?">

      <button class="btn-search" id="btnSearch">Search</button>
      <a href="#" class="advanced-search">Advanced search »</a>
    </div>

    <!-- Banner Carousel -->
    <div class="hero-banner">
      <div class="carousel">
        <div class="slides">
          <img src="assets/images/banner1.png" alt="Banner 1">
          <img src="assets/images/banner2.png" alt="Banner 2">
          <img src="assets/images/banner3.png" alt="Banner 3">
        </div>
        <div class="carousel-controls">
          <span class="prev">&#10094;</span>
          <span class="next">&#10095;</span>
        </div>
      </div>
    </div>

  </section>

  <!-- Car Listings -->
  <section class="listings">
    <h2>Latest Car Listings</h2>
    <div class="car-grid" id="carGrid">
      <p>Loading cars...</p>
    </div>
  </section>

  <!-- Placeholder for footer -->
  <div id="footer"></div>

  <!-- Firebase + Logic -->
  <script type="module">
    // Import Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, query, orderBy, limit, getDocs, where } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyD882u-zk7FB3YMwL0Nm3_VYD4xsCMt6cQ",
      authDomain: "carlisting-f88f2.firebaseapp.com",
      projectId: "carlisting-f88f2",
      storageBucket: "carlisting-f88f2.appspot.com",
      messagingSenderId: "49221518207",
      appId: "1:49221518207:web:c5e2fd962b802322bfd04a"
    };

    // Init Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const carGrid = document.getElementById("carGrid");

    // Load Latest Cars
    async function loadLatestCars() {
      carGrid.innerHTML = "<p>Loading cars...</p>";

      const q = query(
        collection(db, "cars"),
        orderBy("createdAt", "desc"),
        limit(6)
      );

      const snap = await getDocs(q);

      if (snap.empty) {
        carGrid.innerHTML = "<p>❌ No cars found</p>";
        return;
      }

      carGrid.innerHTML = "";
      snap.forEach(doc => {
        const car = doc.data();
        const card = document.createElement("div");
        card.className = "car-card";
        card.innerHTML = `
          <img src="${car.images?.[0] || "assets/images/no-image.png"}" alt="${car.model}">
          <h3>${car.brand} ${car.model}</h3>
          <p>Year: ${car.year} | Price: RM${car.price.toLocaleString()}</p>
          <button onclick="window.location.href='CarDetail.html?id=${doc.id}'">View Details</button>
        `;
        carGrid.appendChild(card);
      });
    }

    // Load Filter Options
    async function loadFilters() {
      const q = query(collection(db, "cars"));
      const snap = await getDocs(q);

      const conditions = new Set();
      const brands = new Set();
      const states = new Set();
      const models = new Set();

      snap.forEach(doc => {
        const car = doc.data();
        if (car.condition) conditions.add(car.condition);
        if (car.brand) brands.add(car.brand);
        if (car.state) states.add(car.state);
        if (car.model) models.add(car.model);
      });

      fillSelect("filterCondition", conditions);
      fillSelect("filterBrand", brands);
      fillSelect("filterState", states);
      fillSelect("filterModel", models);
    }

    function fillSelect(id, items) {
      const select = document.getElementById(id);
      items.forEach(val => {
        const option = document.createElement("option");
        option.value = val;
        option.textContent = val;
        select.appendChild(option);
      });
    }

    // Search Function
    document.getElementById("btnSearch").addEventListener("click", async () => {
      const condition = document.getElementById("filterCondition").value;
      const brand = document.getElementById("filterBrand").value;
      const model = document.getElementById("filterModel").value;
      const state = document.getElementById("filterState").value;
      const price = document.getElementById("filterPrice").value;
      const searchText = document.getElementById("filterSearch").value.toLowerCase();

      let constraints = [];

      if (condition) constraints.push(where("condition", "==", condition));
      if (brand) constraints.push(where("brand", "==", brand));
      if (model) constraints.push(where("model", "==", model));
      if (state) constraints.push(where("state", "==", state));

      let q = query(collection(db, "cars"), ...constraints, orderBy("createdAt", "desc"), limit(12));
      const snap = await getDocs(q);

      carGrid.innerHTML = snap.empty ? "<p>No cars match your filter.</p>" : "";

      snap.forEach(doc => {
        const car = doc.data();

        // Price filter (done in frontend because Firestore range queries are limited)
        if (price === "below50" && car.price > 50000) return;
        if (price === "50to100" && (car.price < 50000 || car.price > 100000)) return;
        if (price === "above100" && car.price < 100000) return;

        // Text search
        const name = `${car.brand} ${car.model}`.toLowerCase();
        if (searchText && !name.includes(searchText)) return;

        const card = document.createElement("div");
        card.className = "car-card";
        card.innerHTML = `
          <img src="${car.images?.[0] || "assets/images/no-image.png"}" alt="${car.model}">
          <h3>${car.brand} ${car.model}</h3>
          <p>Year: ${car.year} | Price: RM${car.price.toLocaleString()}</p>
          <button onclick="window.location.href='car_detail.html?id=${doc.id}'">View Details</button>
        `;
        carGrid.appendChild(card);
      });
    });

    // Init
    loadLatestCars();
    loadFilters();
  </script>

  <!-- Carousel Script -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const slides = document.querySelector(".slides");
      const images = document.querySelectorAll(".slides img");
      const prev = document.querySelector(".prev");
      const next = document.querySelector(".next");

      let index = 0;

      function showSlide(i) {
        if (i >= images.length) index = 0;
        if (i < 0) index = images.length - 1;
        slides.style.transform = `translateX(${-index * 100}%)`;
      }

      next.addEventListener("click", () => {
        index++;
        showSlide(index);
      });

      prev.addEventListener("click", () => {
        index--;
        showSlide(index);
      });

      setInterval(() => {
        index++;
        showSlide(index);
      }, 5000);
    });
  </script>

  <!-- Navbar & Footer -->
  <script type="module">
    import { loadNavbar } from "./assets/js/Navbar.js";
    loadNavbar();
  </script>
  <script type="module">
    import { loadFooter } from "./assets/js/Footer.js";
    loadFooter();
  </script>

</body>
</html>
