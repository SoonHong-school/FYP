<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Car Listing Website</title>
  <link rel="stylesheet" href="assets/css/Homepage.css">
  <link rel="stylesheet" href="assets/css/Footer.css">
</head>

<body>

  <div id="navbar"></div>

  <!-- Hero Section -->
  <section class="hero-container">

    <!-- Filter Box -->
    <div class="filter-box">
      <h3>Find new & used cars for sale</h3>

      <!-- Car Type -->
      <select id="filterType">
        <option value="">Select Type</option>
        <option value="EV">EV</option>
        <option value="Petrol">Petrol</option>
        <option value="Hybrid">Hybrid</option>
      </select>

      <!-- Brand -->
      <select id="filterBrand">
        <option value="">All Brands</option>
      </select>

      <!-- Price Range -->
      <label for="filterPrice">Price Range (RM)</label>
      <input type="range" id="filterPrice" min="10000" max="900000" step="5000" value="100000" />
      <span id="priceValue">RM100,000</span>

      <!-- Year -->
      <select id="filterYear">
        <option value="">All Years</option>
      </select>

      <button class="btn-search" id="btnSearch">Search</button>
      <a href="#" class="advanced-search">Advanced search »</a>
    </div>

    <!-- Banner Carousel -->
    <div class="hero-banner">
      <div class="carousel">
        <div class="slides">
          <img src="assets/images/banner1.png" alt="Banner 1">
          <img src="assets/images/banner2.png" alt="Banner 2">
          <img src="assets/images/banner3.png" alt="Banner 3">
        </div>
        <div class="carousel-controls">
          <span class="prev">&#10094;</span>
          <span class="next">&#10095;</span>
        </div>
      </div>
    </div>

  </section>

  <!-- Car Listings -->
  <section class="listings">
    <h2>Latest Car Listings</h2>
    <div class="car-grid" id="carGrid">
      <p>Loading cars...</p>
    </div>
  </section>

  <!-- Placeholder for footer -->
  <div id="footer"></div>

  <!-- Firebase + Logic -->
  <script type="module">
    // Import Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, query, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyD882u-zk7FB3YMwL0Nm3_VYD4xsCMt6cQ",
      authDomain: "carlisting-f88f2.firebaseapp.com",
      projectId: "carlisting-f88f2",
      storageBucket: "carlisting-f88f2.appspot.com",
      messagingSenderId: "49221518207",
      appId: "1:49221518207:web:c5e2fd962b802322bfd04a"
    };

    // Init Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const carGrid = document.getElementById("carGrid");

    // Load Latest Cars (always 4)
    async function loadLatestCars() {
      carGrid.innerHTML = "<p>Loading cars...</p>";

      const q = query(
        collection(db, "cars"),
        orderBy("createdAt", "desc"),
        limit(4)
      );

      const snap = await getDocs(q);
      carGrid.innerHTML = "";

      if (snap.empty) {
        carGrid.innerHTML = "<p>❌ No cars found</p>";
        return;
      }

      snap.forEach(doc => {
        const car = doc.data();
        const card = document.createElement("div");
        card.className = "car-card";
        card.innerHTML = `
          <img src="${car.images?.[0] || "assets/images/no-image.png"}" alt="${car.model}">
          <h3>${car.brand} ${car.model}</h3>
          <p>Year: ${car.year} | Price: RM${car.price.toLocaleString()}</p>
          <button onclick="window.location.href='CarDetail.html?id=${doc.id}'">View Details</button>
        `;
        carGrid.appendChild(card);
      });
    }

    // Load Filter Options
    async function loadFilters() {
      const q = query(collection(db, "cars"));
      const snap = await getDocs(q);

      const brands = new Set();
      const years = new Set();

      snap.forEach(doc => {
        const car = doc.data();
        if (car.brand) brands.add(car.brand);
        if (car.year) years.add(car.year);
      });

      fillSelect("filterBrand", brands);
      fillSelect("filterYear", years);
    }

    function fillSelect(id, items) {
      const select = document.getElementById(id);
      items.forEach(val => {
        const option = document.createElement("option");
        option.value = val;
        option.textContent = val;
        select.appendChild(option);
      });
    }

    // Price slider value update
    document.getElementById("filterPrice").addEventListener("input", (e) => {
      document.getElementById("priceValue").textContent = "RM" + parseInt(e.target.value).toLocaleString();
    });

    // Redirect to CarListing page
    document.getElementById("btnSearch").addEventListener("click", () => {
      const type = document.getElementById("filterType").value;
      const brand = document.getElementById("filterBrand").value;
      const price = document.getElementById("filterPrice").value;
      const year = document.getElementById("filterYear").value;

      if (!type) {
        alert("Please select EV or Petrol first!");
        return;
      }

      // Choose page based on type
      const page = type === "EV" ? "EvCar.html" : "PetrolCar.html";

      // Redirect with query params
      const params = new URLSearchParams({ brand, price, year });
      window.location.href = `${page}?${params.toString()}`;
    });

    // Init
    loadLatestCars();
    loadFilters();
  </script>

  <!-- Carousel Script -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const slides = document.querySelector(".slides");
      const images = document.querySelectorAll(".slides img");
      const prev = document.querySelector(".prev");
      const next = document.querySelector(".next");

      let index = 0;

      function showSlide(i) {
        if (i >= images.length) index = 0;
        if (i < 0) index = images.length - 1;
        slides.style.transform = `translateX(${-index * 100}%)`;
      }

      next.addEventListener("click", () => {
        index++;
        showSlide(index);
      });

      prev.addEventListener("click", () => {
        index--;
        showSlide(index);
      });

      setInterval(() => {
        index++;
        showSlide(index);
      }, 5000);
    });
  </script>

  <!-- Navbar & Footer -->
  <script type="module">
    import { loadNavbar } from "./assets/js/Navbar.js";
    loadNavbar();
  </script>
  <script type="module">
    import { loadFooter } from "./assets/js/Footer.js";
    loadFooter();
  </script>

</body>
</html>
